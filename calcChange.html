<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>找零計算機</title>
</head>
<body>
  <div class="col-6 mx-auto text-center py-3 mb-2">
    客人 <input type="text" class="mx-2" id="customerId" placeholder=" 名..."> <span class="text-danger" id="errorNameReq"></span>
  </div>
  <div class="container-fluid">
    <div class="row my-2">
      <button type="button" class="btn btn-info col-md col-sm" onclick="clearAmount()">再算一次</button>
      <button type="button" class="btn btn-outline-primary col-md col-sm" onclick="changeOrder()">改單</button>
    </div>
    <div class="row my-2">
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(300)"> 300 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(100)"> 100 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(90)"> 90 </button>
    </div>
    <div class="row my-2">
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(80)"> 80 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(70)"> 70 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(60)"> 60 </button>
    </div>
    <div class="row my-2">
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(50)"> 50 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(40)"> 40 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(30)"> 30 </button>
    </div>
    <div class="row my-2">
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(20)"> 20 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(10)"> 10 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(5)"> 5 </button>
    </div>
    <div class="row mt-4">
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(500)"> 500 </button>
      <button class="btn btn-outline-secondary col-md col-sm" onclick="paidAmount(1000)"> 1000 </button>
    </div>
    <div class="row my-2">
      <button type="button" class="btn btn-info col-md col-sm" onclick="clearAmount()">再算一次</button>
      <button type="button" class="btn btn-outline-primary col-md col-sm" onclick="changeOrder()">改單</button>
    </div>

    <div class="d-flex align-items-center text-center flex-nowrap mx-auto" style="max-width: 500px;">
      <div class="input-group input-group-md">
        <span class="input-group-text">$</span>
        <input type="text" class="form-control" id="customerPaid" placeholder="收到" readonly>
      </div>
      <span class="mx-1">−</span>
      <div class="input-group input-group-md">
        <span class="input-group-text">$</span>
        <input type="text" class="form-control" id="totalAmt" placeholder="訂單" readonly>
      </div>
      <span class="mx-1">=</span>
      <div class="input-group input-group-md">
        <span class="input-group-text">$</span>
        <input type="text" class="form-control" id="totalChg" placeholder="找零" readonly>
      </div>
    </div>
  </div>

  <div id="error"> </div>
  <div id="orderList" class="container-fluid my-3"> </div>

  <script>
    let _sessionKey = "veggiBill";
    let _backOrderSessionKey = "veggiBackOrder";
    let _orderNameKey = "veggieOrderName";

    let _orderStr = sessionStorage.getItem(_sessionKey);
    let _order = JSON.parse(_orderStr);
    let _customerPaid = 0;
    let _totalOrderAmt = 0;
    let _totalChgColor;
    let _orderListNode = document.getElementById("orderList");
    let _customerIdboxNode = document.getElementById("customerId");
    let _customerPaidNode = document.getElementById("customerPaid");
    let _totalChgNode = document.getElementById("totalChg");

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Document loaded!');
      showOrders();
      sumCalcChangeOrders();
      // RGB format
      _totalChgColor = window.getComputedStyle(_customerPaidNode).color;
    });
    _customerIdboxNode.addEventListener('input', function () {
      document.title = _customerIdboxNode.value || '-找零';
    });


    function removeChildren(pNode) {
      console.log(Date.now() + ' func:removeChildren(pNode)');
      while (pNode.firstChild) {
        pNode.removeChild(pNode.firstChild);
      }
    }

    function paidAmount(addAmt) {
      console.log(Date.now() + ` func:paidAmount(addAmt:${addAmt})`);
      _customerPaid += addAmt;
      document.getElementById('customerPaid').value = _customerPaid;
      document.getElementById('totalChg').value = _customerPaid - _totalOrderAmt;
      if (_customerPaid - _totalOrderAmt < 0) {
        _totalChgNode.style.color = "red";
      } else {
        _totalChgNode.style.color = _totalChgColor;
      }
    }

    function clearAmount() {
      console.log(Date.now() + ' func:clearAmount()');
      _customerPaid = 0;
      // Update formula view
      paidAmount(0);
    }

    function changeOrder() {
      console.log(Date.now() + ' func:changeOrder()');
      try {
        let custName = _customerIdboxNode.value.trim();
        if (custName.length === 0) {
          custName = prompt('請輸入客人名:');
        }
        if (custName.length > 0) {
          _customerIdboxNode.value = custName;
          document.getElementById('errorNameReq').innerText = '';
        } else {
          document.getElementById('errorNameReq').innerText = '需要輸入客人名';
          return;
        }
        console.log('  > _order : ' + JSON.stringify(_order));
        if (window.opener) {
          window.opener.postMessage({
            type: _backOrderSessionKey,
            payload: JSON.stringify(_order)
          }, '*');
          window.opener.postMessage({
            type: _orderNameKey,
            payload: custName
          }, '*');
        }
        window.alert('請到訂單計算機頁面點選 "改單" 讀取資料');
        window.close();
      }
      catch (error) {
        console.log(`  > func:changeOrder, error:${error}`);
        document.getElementById('error').value = '改單有錯誤(changeOrder)';
      }
    }

    // Display current order list
    function showOrders() {
      console.log(Date.now() + ' func:showOrders()');
      let txBoxid = 1;
      try {
        for (const key in _order) {
          let tbId = 'tbId' + txBoxid++;
          // console.log('  > key:' + key);
          const row = document.createElement('div');
          row.classList.add('row', 'mb-2');

          const div1 = document.createElement('div');
          div1.className = 'col-12 col-md-3 d-flex justify-content-center justify-content-md-end align-items-center';
          const label = document.createElement('label');
          label.textContent = key + ' (x' + _order[key].count + ') : $ ' + (_order[key].count * _order[key].price);
          div1.appendChild(label);

          // Controls wrapper for plus button, count textbox, minus button
          const controlsRow = document.createElement('div');
          controlsRow.className = 'col-12 col-md-9';
          const innerRow = document.createElement('div');
          innerRow.className = 'row g-2';

          const div2 = document.createElement('div');
          div2.className = 'col-5';
          const btnPlus = document.createElement('button');
          btnPlus.className = 'btn btn-outline-primary w-100';
          btnPlus.type = 'button';
          btnPlus.textContent = ' + 加 + ';
          btnPlus.onclick = () => addOrderCount(key, tbId);
          div2.appendChild(btnPlus);

          const div3 = document.createElement('div');
          div3.className = 'col-2';
          const tbCount = document.createElement('input');
          tbCount.type = 'text';
          tbCount.classList.add('text-center', 'w-100', 'form-control');
          tbCount.value = 1;
          tbCount.setAttribute('id', tbId);
          tbCount.addEventListener('click', function () { this.select(); });
          tbCount.addEventListener('focus', function () { this.select(); });
          tbCount.addEventListener('input', function () {
            // remove non-digits
            this.value = this.value.replace(/\D/g, '');
          });
          div3.appendChild(tbCount);

          const div4 = document.createElement('div');
          div4.className = 'col-5';
          const btnMinus = document.createElement('button');
          btnMinus.className = 'btn btn-outline-info w-100';
          btnMinus.type = 'button';
          btnMinus.textContent = ' - 減 - ';
          btnMinus.onclick = () => removeOrderCount(key, tbId);
          div4.appendChild(btnMinus);

          innerRow.appendChild(div2);    // plus button
          innerRow.appendChild(div3);    // count textbox
          innerRow.appendChild(div4);    // minus button
          controlsRow.appendChild(innerRow);

          row.appendChild(div1);         // label
          row.appendChild(controlsRow);  // controls
          _orderListNode.appendChild(row);
        }
      } catch (error) {
        console.log(`  > func:showOrders, error:${error}`);
        document.getElementById('error').value = '產生選單過程有錯(showOrders)';
      }
    }

    function sumCalcChangeOrders() {
      console.log(Date.now() + ' func:sumCalcChangeOrders()');
      let total = 0;
      for (const key in _order) {
        console.log('  > ' + key + ': order count: ' + _order[key].count + ' price - ' + _order[key].price);
        total += _order[key].count * _order[key].price;
      }
      if (total == 0) {
        document.getElementById('totalAmt').value = "$ 訂單...";
        _totalOrderAmt = 0;
      } else {
        document.getElementById('totalAmt').value = total;
        _totalOrderAmt = total;
      }
      // Set to zero to not change value but update formula view
      paidAmount(0);
    }

    function addOrderCount(key, countTextboxId) {
      console.log(Date.now() + ` func:addOrderCount(key:${key}, countTextboxId:${countTextboxId})`);
      try {
        let count = parseInt(document.getElementById(countTextboxId).value);
        addOrder(key, count);
      } catch (error) {
        console.log(`  > func:addOrderCount, error:${error}`);
        document.getElementById('error').value = '加點有錯誤(addOrderCount)';
      }
    }

    // At first time being called, it initializes and adds one instance,
    // with the count and price to the array.
    // In subsequent calls, it increments or decrements counter.
    function addOrder(key, count, price) {
      console.log(Date.now() + ` func:addOrder(key:${key}, count:${count}, price:$${price})`);
      try {
        if (_order.hasOwnProperty(key)) {
          console.log('  > Already has key: ' + key + '& count: ' + _order[key].count);
          _order[key].count = _order[key].count + count;
        } else {
          if (price === undefined || price === null) {
            console.log(`  > Price is invalid for new key: ${key}`);
            document.getElementById('error').value =
              `Price setting is missing value or invalid for new key: ${key}`;
            return;
          }
          _order[key] = {};
          _order[key].price = price;
          _order[key].count = count;
          console.log(`  > New key: ${key}, count: ${_order[key].count}`);
        }
        removeChildren(_orderListNode);
        showOrders();
        sumCalcChangeOrders();
      } catch (error) {
        console.log(`  > func:addOrder, error:${error}`);
        document.getElementById('error').value = '點單有錯誤(addOrder)';
      }
    }

    function removeOrderCount(key, countTextboxId) {
      console.log(Date.now() + ` func:removeOrderCount(key:${key}, countTextboxId:${countTextboxId})`);
      try {
        let count = parseInt(document.getElementById(countTextboxId).value);
        removeOrder(key, count);
      } catch (error) {
        console.log(`  > func:removeOrderCount, error:${error}`);
        document.getElementById('error').value = '刪點有錯誤(removeOrderCount)';
      }
    }

    function removeOrder(key, count) {
      console.log(Date.now() + ` func:removeOrder(key:${key}, count:${count})`);
      try {
        if (_order.hasOwnProperty(key)) {
          if (_order[key].count >= 1) {
            _order[key].count = _order[key].count - count;
          }
          if (_order[key].count <= 0) {
            delete _order[key];
          }
          removeChildren(_orderListNode);
          showOrders();
          sumCalcChangeOrders();
        }
      } catch (error) {
        console.log(`  > func:removeOrder, error:${error}`);
        document.getElementById('error').value = '刪單有錯誤(removeOrder)';
      }
    }
  </script>
</body>
</html>
<!-- calcChange-8v2 -->
