<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="統計訂單總額，找零">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>訂單計算機</title>

  <link rel="apple-touch-icon" href="carrot-apple.png" sizes="180x180">
  <link rel="icon" href="carrot.ico">

</head>
<body>
  <div class="container-fluid">
    <!-- class="d-flex flex-wrap align-items-center justify-content-center py-3 mb-2" -->
    <header>
      <div class="d-flex flex-wrap justify-content-center mb-2 mt-2">
        <ul class="nav">
          <li>
            <a class="nav-link active px-2" id="btnMenuAll" href="#" onclick="showMenu(-1, 1)">- 全 -</a>
          </li>
          <li>
            <a class="nav-link px-2" id="btnMenu1" href="#" onclick="showMenu(1, 1)">無蛋奶素</a>
          </li>
          <li>
            <a class="nav-link px-2" id="btnMenu2" href="#" onclick="showMenu(2, 1)">蔬菜類</a>
          </li>
          <li>
            <a class="nav-link px-2" id="btnMenu3" href="#" onclick="showMenu(3, 1)">熟食區</a>
          </li>
          <li>
            <a class="nav-link px-2" id="btnMenu4" href="#" onclick="showMenu(4, 1)">蛋奶素</a>
          </li>
          <li>
            <a class="nav-link px-2" id="btnMenu5" href="#" onclick="showMenu(5, 1)">素漢堡</a>
          </li>
          <li>
            <a class="nav-link px-2" id="btnMenu6" href="#" onclick="showMenu(6, 1)">加購區</a>
          </li>
          <li>
            <div class="input-group input-group-md">
              <span class="input-group-text">$</span>
              <input type="text" class="form-control" id="totalAmt" placeholder="訂單" maxlength="6" size="6" readonly>
            </div>
          </li>
          <li>
            <button type="button" id="btnClearOrder" class="btn btn-warning mx-1" onclick="clearOrder()">新 單</button>
          </li>
          <li>
            <button type="button" id="btnCalcChange" class="btn btn-warning mx-1" onclick="calcChange()">結 賬</button>
          </li>
          <li>
            <button type="button" id="btnShowChangeOrder" class="btn btn-warning mx-2" onclick="showChangeOrder()">改 單</button>
          </li>
        </ul>
      </div>
    </header>
    <div>
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <li class="page-item">
            <button class="btn btn-success" id="pagePre" aria-label="Previous" onclick="showMenu(_currentFilter, _currentPage-1)">
              <span aria-hidden="true"> &laquo; 上頁 </span>
            </button>
          </li>
          <li class="page-item">
            <span class="mx-3 fs-4" id="pageNum"> 1 </span>
          </li>
          <li class="page-item">
            <button class="btn btn-success" id="pageNext" aria-label="Next" onclick="showMenu(_currentFilter, _currentPage+1)">
              <span aria-hidden="true"> 下頁 &raquo; </span>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <div class="text-danger" id="errMsg"> </div>
  <div id="menuList" class="container-fluid my-3"> </div> <!-- mt-3-->
  <div id="orderList" class="container-fluid my-3"> </div>

  <script>
    let _menu = {
      // 無蛋奶素, key == 1
      "1": [
        { name: "脆薯條 小", price: 35 }, { name: "脆薯條 大", price: 55 },
        { name: "微笑薯餅 5個", price: 35 }, { name: "三角薯餅 4個", price: 35 },
        { name: "帶皮薯條", price: 50 }, { name: "杏鮑菇 小", price: 35 },
        { name: "杏鮑菇 大", price: 55 }, { name: "秀珍菇 小", price: 35 },
        { name: "秀珍菇 大", price: 55 }, { name: "香菇 小", price: 35 },
        { name: "香菇 大", price: 55 }, { name: "珊瑚菇 小", price: 35 },
        { name: "珊瑚菇 大", price: 55 }, { name: "金針菇 小", price: 35 },
        { name: "金針菇 大", price: 55 }, { name: "雪白菇", price: 55 },
        { name: "鹽酥G 小", price: 35 }, { name: "鹽酥G 大", price: 55 },
        { name: "地瓜條 小", price: 35 }, { name: "地瓜條 大", price: 55 },
        { name: "米雪", price: 30 }, { name: "烤米雪", price: 35 },
        { name: "豆干", price: 30 }, { name: "豆包腸", price: 30 },
        { name: "銀絲卷", price: 30 }, { name: "蔬菜餅", price: 30 },
        { name: "香椿餅", price: 35 }, { name: "蘿蔔糕", price: 30 },
        { name: "小熱狗", price: 30 }, { name: "傳統豆腐", price: 35 },
        { name: "素豆G", price: 35 }, { name: "芋粿签", price: 35 },
        { name: "黃金芋球", price: 40 }, { name: "炸餛飩", price: 40 },
        { name: "百頁豆腐", price: 40 }, { name: "卡拉G腿", price: 50 },
        { name: "蚵仔酥", price: 55 }, { name: "G米花", price: 55 },
        { name: "海苔風味炸G", price: 70 }, { name: "泰式炸G", price: 70 },
        { name: "韓式炸G", price: 70 }, { name: "豪大G排", price: 75 },
        { name: "豪大G排+薯條", price: 100 },
      ],
      // 蔬菜類, key == 2
      "2": [
        { name: "青椒", price: 30 }, { name: "小黃瓜", price: 30 },
        { name: "玉米", price: 35 }, { name: "四季豆", price: 35 },
        { name: "玉米筍", price: 40 },
      ],
      // 熟食區, key == 3
      "3": [
        { name: "脆皮素肉圓", price: 40 }, { name: "粉絲煲", price: 45 },
        { name: "YES素原味水餃", price: 45 },
      ],
      // 蛋奶素, key == 4
      "4": [
        { name: "甜不辣 小", price: 35 }, { name: "甜不辣 大", price: 55 },
        { name: "素魷魚呼啦圈 5個", price: 40 }, { name: "素魷魚呼啦圈 9個", price: 60 },
        { name: "鷄蛋豆腐 半盒", price: 35 }, { name: "鷄蛋豆腐 整盒", price: 60 },
        { name: "乳酪棒", price: 20 }, { name: "聰明小丸子", price: 40 },
        { name: "咖哩小G塊", price: 40 },
        { name: "單點豬G牛", price: 50 }, { name: "黃金蝦", price: 60 },
        { name: "披薩", price: 55 }, { name: "月亮菇排", price: 70 },
        { name: "碳烤G排", price: 80 }, { name: "凱薩", price: 85 },
      ],
      // 素漢堡, key == 5
      "5": [
        { name: "素食大亨堡", price: 65 }, { name: "咔啦潛艇堡", price: 70 },
        { name: "叉燒潛艇堡", price: 70 }, { name: "豆包漢堡", price: 75 },
        { name: "龍蝦漢堡", price: 80 }, { name: "豬排漢堡", price: 70 },
        { name: "G排漢堡", price: 70 }, { name: "牛排漢堡", price: 70 },
        { name: "香辣G腿漢堡", price: 70 }, { name: "烤鴨素漢堡", price: 70 },
        { name: "炸蝦漢堡", price: 70 },
      ],
      // 加購區, key == 6
      "6": [
        { name: "微笑薯餅", price: 30 }, { name: "薯條", price: 30 },
        { name: "乳酪棒x3", price: 45 },
      ]
    };

    let _strColl = {
      "btn_ChangeOrder": { tw: "改單", en: "Change Order" }
    };
    // console.log(_strColl["btn_ChangeOrder"]["en"]); // Change Order

    let _sessionKey = "veggiBill";
    let _backOrderSessionKey = "veggiBackOrder";
    let _orderNameKey = "veggieOrderName";

    let _columnCount = 4;     // Number of columns. Ex: 1,2,3,4,6,12
    let _cellsPerPage = 20;   // Number of menu item per page
    let _currentPage = 1;     // Current page number
    let _currentFilter = -1;  // Initial value is -1. Ex: -1: all, 1: first key, 2: second key, ...
    let _countInputTimer;     // Timer for count input box
    let _calcChangeFileName = "calcChange.html";
    let _orderCustomerName;    // customer name for the order
    let _order = {};
    let _backOrderStr;
    let _totalOrderAmt = 0;
    let _keys = Object.keys(_menu).map(k => k.trim());
    let _orderListNode = document.getElementById("orderList");
    let _menuListNode = document.getElementById("menuList");
    let _pageNumNode = document.getElementById("pageNum");
    let _pagePreNode = document.getElementById("pagePre");
    let _pageNextNode = document.getElementById("pageNext");
    let _showChangeOrderBtnNode = document.getElementById("btnShowChangeOrder");

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Document loaded!');
      showMenu(-1, 1);
    });

    window.addEventListener('message', (event) => {
      // Listen to back order object from child tab
      if (event.data.type === _backOrderSessionKey) {
        console.log('Received from child tab: ' + event.data.payload);
        _backOrderStr = event.data.payload;
      }
      // Listen to customer name from child tab
      if (event.data.type === _orderNameKey) {
        console.log('Received from child tab: ' + event.data.payload);
        _orderCustomerName = event.data.payload;
      }
    });

    function updateErrLabel(funcName, message, errException) {
      if (funcName === undefined || funcName === null || funcName === '') {
        document.getElementById('errMsg').innerText = '';
      } else {
        console.log(`  > func:${funcName}, error: ${errException}`);
        document.getElementById('errMsg').innerText = `${message}(${funcName})`;
      }
    }

    // Go through the menu items and show them as buttons
    function showMenu(filter, selectPage) {
      console.log(Date.now() + ` func:showMenu(filter:${filter}, selectPage:${selectPage})`);
      try {
        _currentFilter = filter;
        _currentPage = selectPage;
        _pageNumNode.textContent = selectPage;
        let itemCount = 0;    // Keep track of currently showing item
        let cellCount = 1;
        let rowDiv = document.createElement("div");
        removeChildren(_menuListNode);
        setPrePageState(selectPage);
        rowDiv.classList.add("row");
        _menuListNode.appendChild(rowDiv);
        // Add menu items as buttons.
        for (let i = 0; i < _keys.length; i++) {
          // Show only selected section, the key in JSON object
          if (filter == -1 || i == (filter - 1)) {
            for (let menuItem = 0; menuItem < _menu[_keys[i]].length; menuItem++) {
              // console.log(`  > _currentPage:${_currentPage}, itemCount: ${itemCount}`);
              itemCount++;
              // Only show items on the current page
              if ((itemCount <= ((selectPage - 1) * _cellsPerPage))
                || ((itemCount + 1) > (selectPage * _cellsPerPage + 1))) {
                // console.log("  > skip: " + _menu[_keys[i]][menuItem].name + " (" + _menu[_keys[i]][menuItem].price + ")");
                continue;
              }
              // console.log(`  > show: ${_menu[_keys[i]][menuItem].name}(${_menu[_keys[i]][menuItem].price})`);
              if (cellCount > _columnCount) {
                rowDiv = document.createElement("div");
                rowDiv.classList.add("row");
                _menuListNode.appendChild(rowDiv);
                cellCount = 1;
              }
              cellCount++;
              const btnMenuItem = document.createElement("button");
              btnMenuItem.type = "button";
              btnMenuItem.textContent = _menu[_keys[i]][menuItem].name + " (" + _menu[_keys[i]][menuItem].price + ")";
              btnMenuItem.classList.add("btn", "btn-outline-secondary", "col-md", "col-sm");
              // Set button click function
              btnMenuItem.onclick = () => addOrder(_menu[_keys[i]][menuItem].name, 1, _menu[_keys[i]][menuItem].price);
              rowDiv.appendChild(btnMenuItem);
            }
          }
        }
        setNextPageState(itemCount);
      } catch (error) {
        updateErrLabel('showMenu', '顯示菜單有錯誤', error);
      }
    }

    function setPrePageState(selectPage) {
      console.log(Date.now() + ` func:setPrePageState(selectPage:${selectPage})`);
      if (selectPage == 1) {
        _pagePreNode.disabled = true;
      } else {
        _pagePreNode.disabled = false;
      }
    }

    function setNextPageState(itemCount) {
      console.log(Date.now() + ` func:setNextPageState(itemCount:${itemCount}, _cellsPerPage:${_cellsPerPage})`);
      let isShowingLastPage = false;
      let quotient = Math.floor(itemCount / _cellsPerPage);
      let remainder = itemCount % _cellsPerPage;
      // console.log(`  > quotient:${quotient}, remainder:${remainder}, _currentPage:${_currentPage}`);
      if (remainder != 0) {
        isShowingLastPage = ((quotient + 1) == _currentPage);
      } else {
        isShowingLastPage = (quotient == _currentPage);
      }
      // console.log('  > isShowingLastPage:' + isShowingLastPage);
      if (isShowingLastPage) {
        _pageNextNode.disabled = true;
      } else {
        _pageNextNode.disabled = false;
      }
    }

    function removeChildren(pNode) {
      console.log(Date.now() + ' func:removeChildren(pNode)');
      while (pNode.firstChild) {
        pNode.removeChild(pNode.firstChild);
      }
    }

    function clearOrder() {
      console.log(Date.now() + ' func:clearOrder()');
      _order = {};
      document.getElementById('totalAmt').value = '';
      updateErrLabel();    // Clear error message
      removeChildren(_orderListNode);
    }

    function calcChange() {
      console.log(Date.now() + ' func:calcChange()');
      if (Object.keys(_order).length === 0 && _order.constructor === Object) {
        console.log('  > Empty order, no bill.');
        window.alert('訂單是空的，無法結賬。');
      } else {
        sessionStorage.removeItem(_sessionKey);
        sessionStorage.setItem(_sessionKey, JSON.stringify(_order));
        window.open(_calcChangeFileName, '_blank');
      }
    }

    function showChangeOrder() {
      console.log(Date.now() + ' func:showChangeOrder()');
      try {
        if (_backOrderStr) {
          const infoStr = `[ ${_orderCustomerName} ] 改單。點選 OK 會刪除現有訂單`;
          const userInput = window.confirm(infoStr);
          if (userInput) {
            _order = JSON.parse(_backOrderStr);
            console.log('  > customer name: ' + _orderCustomerName + ', _order: ' + _order);
            removeChildren(_orderListNode);
            showOrders();
            sumOrders();
          }
        } else {
          console.log('  > Did not receive any change order or data is empty from child window.');
          window.alert('沒收到改單資料。');
        }
      } catch (error) {
        updateErrLabel('showChangeOrder', '顯示改單有錯誤', error);
      }
    }

    // Display current order list
    function showOrders() {
      console.log(Date.now() + ' func:showOrders()');
      let txBoxid = 1;
      try {
        for (const key in _order) {
          let rowId = 'rowId' + txBoxid++;
          let tbId = 'tbId' + txBoxid++;
          let lbId = 'lbId' + txBoxid++;
          // console.log('  > key:' + key);
          const row = document.createElement('div');
          row.setAttribute('id', rowId);
          row.classList.add('row', 'mb-2');

          const div1 = document.createElement('div');
          div1.className = 'col-12 col-md-3 d-flex justify-content-center justify-content-md-end align-items-center';
          const label = document.createElement('label');
          label.textContent = updateLabel(lbId, key);
          label.setAttribute('id', lbId);
          div1.appendChild(label);

          // Controls wrapper for plus button, count textbox, minus button
          const controlsRow = document.createElement('div');
          controlsRow.className = 'col-12 col-md-9';
          const innerRow = document.createElement('div');
          innerRow.className = 'row g-2';

          const div2 = document.createElement('div');
          div2.className = 'col-5';
          const btnPlus = document.createElement('button');
          btnPlus.className = 'btn btn-outline-primary w-100';
          btnPlus.type = 'button';
          btnPlus.textContent = ' + 加 1 + ';
          btnPlus.onclick = () => addOrder(key, 1);
          div2.appendChild(btnPlus);

          const div3 = document.createElement('div');
          div3.className = 'col-2';
          const tbCount = document.createElement('input');
          tbCount.type = 'number';
          tbCount.inputmode = 'numeric';
          tbCount.classList.add('text-center', 'w-100', 'form-control');
          tbCount.value = _order[key].count;
          tbCount.setAttribute('id', tbId);
          tbCount.addEventListener('click', function () { this.select(); });
          tbCount.addEventListener('focus', function () { this.select(); });
          tbCount.addEventListener('input', function () {
            // remove non-digits
            this.value = this.value.replace(/\D/g, '');
            clearTimeout(_countInputTimer);
            _countInputTimer = setTimeout(() => {
              if (tbCount.value === '') {
                _order[key].count = 0;
              } else {
                _order[key].count = parseInt(tbCount.value);
              }
              console.log(`  > User set key:${key}, purchase count:${parseInt(tbCount.value)}`);
              updateLabel(lbId, key);
              sumOrders();
            }, 800);
          });
          div3.appendChild(tbCount);

          const div4 = document.createElement('div');
          div4.className = 'col-5';
          const btnMinus = document.createElement('button');
          btnMinus.className = 'btn btn-outline-info w-100';
          btnMinus.type = 'button';
          btnMinus.textContent = ' - 減 1 - ';
          btnMinus.onclick = () => removeOrder(key, 1);
          div4.appendChild(btnMinus);

          innerRow.appendChild(div2);    // plus button
          innerRow.appendChild(div3);    // count textbox
          innerRow.appendChild(div4);    // minus button
          controlsRow.appendChild(innerRow);

          row.appendChild(div1);         // label
          row.appendChild(controlsRow);  // controls
          _orderListNode.appendChild(row);
        }
      } catch (error) {
        updateErrLabel('showOrders', '產生選單過程有錯', error);
      }
    }

    // Generate the label text for the order item.
    // If label id exists, update the label text, else return the label string.
    // It shows the item name, purchased count and total price.
    function updateLabel(labelId, indexKey) {
      console.log(Date.now() + ` func:updateLabel(labelId:${labelId}, indexKey:${indexKey})`);
      let labelStr;
      let node;
      try {
        labelStr = indexKey + ' (x' + _order[indexKey].count + ') : $ '
          + (_order[indexKey].count * _order[indexKey].price);
        // if not found, exist quietly
        node = document.getElementById(labelId);
        if (node) {
          node.innerText = labelStr;
        }
      } catch (error) {
        updateErrLabel('updateLabel', '更新購買項目錯誤', error);
      }
      return labelStr;
    }

    // Assume the item is already in the order list before calling.
    // This function will update the purchased count of the item.
    function updateOrderCount(key, count) {
      console.log(Date.now() + ` func:updateOrderCount(key:${key}, count:${count})`);
      try {
        _order[key].count = count;
        removeChildren(_orderListNode);
        showOrders();
        sumOrders();
      } catch (error) {
        updateErrLabel('addOrder', '點單有錯誤', error);
      }
    }

    function sumOrders() {
      console.log(Date.now() + ' func:sumOrders()');
      let total = 0;
      for (const key in _order) {
        console.log(`  > key:${key}, count: ${_order[key].count}, price: ${_order[key].price}`);
        total += _order[key].count * _order[key].price;
      }
      if (total == 0) {
        document.getElementById('totalAmt').value = "$ 訂單...";
      } else {
        document.getElementById('totalAmt').value = total;
      }
    }

    // At first time being called, it initializes and adds one instance,
    // with the count and price to the array.
    // In subsequent calls, it increments or decrements counter.
    function addOrder(key, count, price) {
      console.log(Date.now() + ` func:addOrder(key:${key}, count:${count}, price:$${price})`);
      try {
        if (_order.hasOwnProperty(key)) {
          console.log(`  > Already has key: ${key} & count: ${_order[key].count}`);
          _order[key].count = _order[key].count + count;
        } else {
          if (price === undefined || price === null) {
            // Price is invalid for new key
            updateErrLabel('addOrder', `無售價設定或對新標識 ${key} 售價值不和法`, null);
            return;
          }
          _order[key] = {};
          _order[key].price = price;
          _order[key].count = count;
          console.log(`  > New key: ${key}, count: ${_order[key].count}`);
        }
        removeChildren(_orderListNode);
        showOrders();
        sumOrders();
      } catch (error) {
        updateErrLabel('addOrder', '點單有錯誤', error);
      }
    }

    function removeOrder(key, count) {
      console.log(Date.now() + ` func:removeOrder(key:${key}, count:${count})`);
      try {
        if (_order.hasOwnProperty(key)) {
          if (_order[key].count >= 0) {
            _order[key].count = _order[key].count - count;
          }
          if (_order[key].count < 0) {
            delete _order[key];
          }
          removeChildren(_orderListNode);
          showOrders();
          sumOrders();
        }
      } catch (error) {
        updateErrLabel('removeOrder', '刪單有錯誤', error);
      }
    }
  </script>
</body>
</html>
<!-- order-9v3 -->
