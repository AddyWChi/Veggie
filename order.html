<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>訂單計算機</title>
</head>
<body>
  <div class="container-fluid">
    <header class="d-flex flex-wrap align-items-center justify-content-center py-3 mb-2">
      <ul class="nav">
        <li>
          <button class="nav-link active px-2 link-secondary" id="btnMenuAll" onclick="showMenu(-1)">- 全 -</button>
        </li>
        <li>
          <button class="nav-link active px-2 link-secondary" id="btnMenu1" onclick="showMenu(1)">無蛋奶素</button>
        </li>
        <li>
          <button class="nav-link active px-2 link-secondary" id="btnMenu2" onclick="showMenu(2)">蔬菜類</button>
        </li>
        <li>
          <button class="nav-link active px-2 link-secondary" id="btnMenu3" onclick="showMenu(3)">熟食區</button>
        </li>
        <li>
          <button class="nav-link active px-2 link-secondary" id="btnMenu4" onclick="showMenu(4)">蛋奶素</button>
        </li>
        <li>
          <button class="nav-link active px-2 link-secondary" id="btnMenu5" onclick="showMenu(5)">素漢堡</button>
        </li>
        <li>
          <input type="text" class="mx-2" id="totalAmt" placeholder=" $ 金額..." disabled>
        </li>
        <li>
          <button type="button" class="btn btn-warning" onclick="clearOrder()">新單</button>
        </li>
      </ul>
    </header>
  </div>

  <div id="error"> </div>
  <div id="menuList" class="container-fluid my-3"> </div>
  <div id="orderList" class="container-fluid my-3"> </div>

  <script>
    let _menu = {
      // 無蛋奶素
      "1": [
        { name: "脆薯條 小", price: 35 }, { name: "脆薯條 大", price: 55 },
        { name: "微笑薯餅 5個", price: 35 },
        { name: "三角薯餅 4個", price: 35 },
        { name: "帶皮薯條", price: 50 },
        { name: "杏鮑菇 小", price: 35 }, { name: "杏鮑菇 大", price: 55 },
        { name: "秀珍菇 小", price: 35 }, { name: "秀珍菇 大", price: 55 },
        { name: "香菇 小", price: 35 }, { name: "香菇 大", price: 55 },
        { name: "珊瑚菇 小", price: 35 }, { name: "珊瑚菇 大", price: 55 },
        { name: "金針菇 小", price: 35 }, { name: "金針菇 大", price: 55 },
        { name: "雪白菇", price: 55 },
        { name: "鹽酥G 小", price: 35 }, { name: "鹽酥G 大", price: 55 },
        { name: "地瓜條 小", price: 35 }, { name: "地瓜條 大", price: 55 },
      ],
      // 蔬菜類
      "2": [
        { name: "青椒", price: 30 },
        { name: "小黃瓜", price: 30 },
        { name: "玉米", price: 35 },
        { name: "四季豆", price: 35 },
        { name: "玉米筍", price: 40 },
      ],
      // 熟食區
      "3": [
        { name: "脆皮素肉圓", price: 40 },
        { name: "粉絲煲", price: 45 },
        { name: "YES素原味水餃", price: 45 },
      ],
      // 蛋奶素
      "4": [
        { name: "甜不辣 小", price: 35 }, { name: "甜不辣 大", price: 55 },
        { name: "素魷魚呼啦圈 5個", price: 40 }, { name: "素魷魚呼啦圈 9個", price: 60 },
        { name: "鷄蛋豆腐 半盒", price: 35 }, { name: "鷄蛋豆腐 整盒", price: 60 },
      ],
      // 素漢堡
      "5": [
        { name: "素食大亨堡", price: 65 },
        { name: "咔啦潛艇堡", price: 70 },
        { name: "叉燒潛艇堡", price: 70 },
      ]
    };

    let _order = {};
    let _orderList = document.getElementById("orderList");
    let _menuList = document.getElementById("menuList");
    let _keys = Object.keys(_menu).map(k => k.trim());
    document.addEventListener("DOMContentLoaded", () => {
      console.log("Document loaded!");
      showMenu(-1);
    });

    function showMenu(showSection) {
      removeChildren(_menuList);
      // Add menu item button.
      // First get all the keys and then loop looping through the elements.
      // Each row has 3 cells
      let cellCount = 1;
      let rowDiv = document.createElement("div");
      rowDiv.classList.add("row");
      _menuList.appendChild(rowDiv);
      // Loop through JSON object's keys
      // and within each key, loop through elements.
      for (let i = 0; i < _keys.length; i++) {
        // console.log("_keys[i]: ..." + _keys[i]);
        // console.log("_menu[_keys[i]].length: ..." + _menu[_keys[i]].length);
        if (showSection == -1 || i == (showSection - 1)) {
          for (let j = 0; j < _menu[_keys[i]].length; j++) {
            // console.log("_menu[_keys[i]][j].name: ..." + _menu[_keys[i]][j].name);
            if (cellCount >= 4) {
              rowDiv = document.createElement("div");
              rowDiv.classList.add("row");
              _menuList.appendChild(rowDiv);
              cellCount = 1;
            }
            const btnMenuItem = document.createElement("button");
            btnMenuItem.type = "button";
            btnMenuItem.textContent = _menu[_keys[i]][j].name + " (" + _menu[_keys[i]][j].price + ")";
            btnMenuItem.classList.add("btn");
            btnMenuItem.classList.add("btn-outline-secondary");
            btnMenuItem.classList.add("col-md-4");
            btnMenuItem.classList.add("col-sm-12");
            // Set button click function
            btnMenuItem.onclick = () => addOrder(_menu[_keys[i]][j].name, _menu[_keys[i]][j].price);
            rowDiv.appendChild(btnMenuItem);
            cellCount++;
          }
        }
      }
    }

    function removeChildren(pNode) {
      console.log(Date.now() + ' function: removeChildren');
      while (pNode.firstChild) {
        pNode.removeChild(pNode.firstChild);
      }
    }

    function clearOrder() {
      _order = {};
      document.getElementById('totalAmt').value = '';
      document.getElementById('error').value = '';
      removeChildren(_orderList);
    }

    function showOrders() {
      console.log(Date.now() + ' function: showOrders - no parameter');
      try {
        for (const key in _order) {
          console.log('showOrders - key:' + key);
          const orderItem = document.createElement("div");
          orderItem.classList.add("row");
          orderItem.innerHTML = "<label class=\"col-4 d-flex justify-content-end\" >"
            + key + " (x" + _order[key].count + ") : $ " + (_order[key].count * _order[key].price) + "</label>"
            + " <button type=\"button\" class=\"col-4 my-1 py-2 px-3 btn btn-outline-primary\" onclick=\"addOrder('" + key + "')\" > + 1 </button>"
            + " <button type=\"button\" class=\"col-4 my-1 py-2 px-3 btn btn-outline-info\" onclick=\"removeOrder('" + key + "')\" > - 1 </button>";
          _orderList.appendChild(orderItem);
        }
      } catch {
        document.getElementById('error').value = 'Error';
      }
    }

    function sumOrders() {
      // console.log(Date.now() + ' function: sumOrders - no parameter');
      let total = 0;
      for (const key in _order) {
        console.log(key + ': order count: ' + _order[key].count + ' price - ' + _order[key].price);
        total += _order[key].count * _order[key].price;
      }
      document.getElementById('totalAmt').value = total;
    }

    function addOrder(key, price) {
      console.log(Date.now() + ' function: addOrder - ' + key + ':$' + price);
      try {
        if (_order.hasOwnProperty(key)) {
          console.log(Date.now() + ' function: addOrder - already has key: ' + key + '& count: ' + _order[key].count);
          _order[key].count = _order[key].count + 1;
        } else {
          console.log(Date.now() + ' function: addOrder - new key: ' + key);
          _order[key] = {};
          _order[key].price = price;
          _order[key].count = 1;
          console.log(Date.now() + ' function: addOrder - new key: ' + key + ' & count: ' + _order[key].count);
        }
        removeChildren(_orderList);
        showOrders();
        sumOrders();
      } catch {
        document.getElementById('error').value = '有錯誤';
      }
    }

    function removeOrder(key) {
      console.log(Date.now() + ' function: removeOrder - ' + key);
      try {
        if (_order.hasOwnProperty(key)) {
          if (_order[key].count > 1) {
            _order[key].count = _order[key].count - 1;
          } else {
            delete _order[key];
          }
        }
        removeChildren(_orderList);
        showOrders();
        sumOrders();
      } catch {
        document.getElementById('error').value = '有錯誤';
      }
    }
  </script>
</body>
</html>